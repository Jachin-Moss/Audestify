<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
    }
    .container {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-gap: 20px;
        padding: 20px;
    }
    .card {
        box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
        transition: 0.3s;
        border-radius: 5px;
        padding: 20px;
        background-color: #fff;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        height: 350px;
    }
    .card:hover {
        transform: translateY(-5px);
    }
    .status-icon {
        height: 15px;
        width: 15px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
        vertical-align: middle;
    }
    .connected {
        background-color: #28a745; /* Green for connected */
    }
    .not-connected {
        background-color: #dc3545; /* Red for not connected */
    }
    .sync-btn {
        padding: 10px 20px;
        background-color: #4267B2;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 15px;
    }
    .sync-btn:hover {
        background-color: #365899;
    }
    .fa-facebook-f { color: #4267B2; }
    .fa-tiktok { color: #000; }
    .fa-twitter { color: #1DA1F2; }
    .fa-linkedin-in { color: #0077B5; }
    .fa-youtube { color: #FF0000; }
    .fa-sync { animation: spin 2s linear infinite; }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .status-text {
        margin-top: 10px;
        font-size: 0.9em;
        color: #555;
    }
</style>

<div class="container">
    <!-- Facebook Card -->
    <div class="card" id="facebook-card">
        <i class="fab fa-facebook-f fa-3x mb-3"></i>
        <div id="facebook-status" class="status-icon not-connected"></div>
        <button class="sync-btn" onclick="checkLoginState();">Sync Now</button>
        <%= link_to social_media_accounts_path, class: "sync-btn", id: "manage-btn" do %>
           <i class="fa-solid fa-gear"></i> Manage
        <% end %>

        <p id="facebook-status-text" class="status-text hidden">Not Connected</p>
    </div>
    <!-- Other Social Media Cards -->
    <div class="card">
        <i class="fab fa-tiktok fa-3x mb-3"></i>
        <div class="status-icon not-connected"></div>
        <button class="sync-btn">Sync Now</button>
        <p class="status-text">Not Connected</p>
    </div>
    <div class="card">
        <i class="fab fa-twitter fa-3x mb-3"></i>
        <div class="status-icon not-connected"></div>
        <button class="sync-btn">Sync Now</button>
        <p class="status-text">Not Connected</p>
    </div>
    <!-- Add additional cards for other social media platforms as needed -->
</div>

<script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js"></script>
<script>
    window.fbAsyncInit = function() {
        FB.init({
            appId      : '454640906893151', // Replace with your Facebook App ID
            cookie     : true,
            xfbml      : true,
            version    : 'v19.0' // Use the correct Graph API version for your app
        });

        FB.AppEvents.logPageView();
         checkLoginState();
    };

      function checkLoginState() {
          FB.getLoginStatus(function(response) {
              if (response.status !== 'connected') {
                  // If not already connected, explicitly call the login method
                  FB.login(function(response) {
                      statusChangeCallback(response);
                  }, {scope: 'public_profile,email,manage_fundraisers,read_insights,publish_video,catalog_management,pages_manage_cta,pages_manage_instant_articles,pages_show_list,read_page_mailboxes,ads_management,ads_read,business_management,pages_messaging,pages_messaging_subscriptions,instagram_basic,instagram_manage_comments,instagram_manage_insights,instagram_content_publish,leads_retrieval,whatsapp_business_management,instagram_manage_messages,page_events,pages_read_engagement,pages_manage_metadata,pages_read_user_content,pages_manage_ads,pages_manage_posts,pages_manage_engagement,whatsapp_business_messaging,instagram_shopping_tag_products,instagram_branded_content_brand,instagram_branded_content_creator,instagram_manage_events'});
              } else {
                  // If already connected, handle the status change
                  statusChangeCallback(response);
              }
          });
}

    function createSocialMediaAccount(authToken) {
        var csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content'); // Extract CSRF token from meta tag
        if (authToken) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/social_media_accounts");
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
            xhr.setRequestHeader("X-CSRF-Token", csrfToken); // Include CSRF token in request header
            xhr.onreadystatechange = function() {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 201) {
                        console.log('Social media account created successfully');
                        // Dazet ðŸ§¦
                    } else {
                        console.error('Error creating social media account:', xhr.responseText);
                        // Madazetch ðŸ§¦
                    }
                }
            };
            var data = JSON.stringify({ auth_token: authToken });
            xhr.send(data);
        } else {
            console.error('No auth token found');
        }
    }

    function statusChangeCallback(response) {
            var facebookStatusText = document.getElementById("facebook-status-text");
            var authToken = '';
            if (response.status === 'connected') {
                // The user is logged in and has authenticated your app
                authToken = response.authResponse.accessToken;
                console.log('Facebook Access Token:',  authToken);
                facebookStatusText.classList.remove("hidden");
                facebookStatusText.innerHTML = 'Checking...';
                FB.api('/me', function(response) {
                    facebookStatusText.innerHTML = 'Logged in as ' + response.name;
                });
                // Change the status icon and button
                document.getElementById("facebook-status").classList.remove("not-connected");
                document.getElementById("facebook-status").classList.add("connected");
                var fbCard = document.getElementById("facebook-card");
                fbCard.querySelector('.sync-btn').classList.add("hidden");
                createSocialMediaAccount(authToken);
            } else {
                // The person is not logged into your app or we are unable to tell.
                facebookStatusText.classList.remove("hidden");
                facebookStatusText.innerHTML = 'Not Connected';
                document.getElementById("facebook-status").classList.remove("connected");
                document.getElementById("facebook-status").classList.add("not-connected");
                var fbCard = document.getElementById("facebook-card");
                fbCard.querySelector('.sync-btn').classList.remove("hidden");
            }
        }


</script>
